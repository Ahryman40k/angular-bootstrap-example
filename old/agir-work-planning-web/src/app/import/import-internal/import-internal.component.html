<h2 class="mt-3 mb-3">Import de données</h2>
<form class="mb-3" [formGroup]="form" (ngSubmit)="launchImport()">
  <div class="mb-3">
    <div *ngIf="showProgress" class="pb-2">
      <div [ngSwitch]="loadStatus">
        <small *ngSwitchCase="'map'">Mise en relation des données...</small>
        <small *ngSwitchCase="'saving'">Sauvegarde des données...</small>
        <small *ngSwitchCase="'done'">Complété!</small>
        <small *ngIf="loadingPercentage" class="pl-1">{{ loadingPercentage }}%</small>
      </div>
      <ngb-progressbar
        type="success"
        [striped]="!isImportDone"
        [animated]="!isImportDone"
        [value]="loadingPercentage"
      ></ngb-progressbar>
    </div>
    <div class="d-flex alert pb-0" *ngIf="showProgress">
      <div *ngIf="mappingResult" class="flex-fill">
        <h5>Statistiques de la mise en relation</h5>
        <div>
          <h6>Total de projets BIC:</h6>
          <p>{{ mappingResult.total }}</p>
        </div>
        <div>
          <h6>Total de projets BIC avec un lien shp:</h6>
          <p>{{ mappingResult.totalSuccess }}</p>
        </div>
        <div>
          <h6>Total de projets BIC sans lien shp:</h6>
          <p>
            <a class="text-primary" [routerLink]="" queryParamsHandling="preserve" (click)="reportFailedMappings()">
              {{ mappingResult.totalFail }}
            </a>
          </p>
        </div>
        <div>
          <h6>
            Pourcentage de projets BIC avec lien:
          </h6>
          <p>{{ mappingResult.successPercentage }}%</p>
        </div>
        <div>
          <h6>Nombres de projets AGIR à sauvegarder:</h6>
          <p>{{ mappingResult.projectsWithFeatures.length }}</p>
        </div>
      </div>
      <div class="flex-fill">
        <h5>Statistiques de sauvegarde</h5>
        <div>
          <h6>Total de projets AGIR sauvegardés:</h6>
          <p>{{ saveResult?.totalSuccess || 0 }}</p>
        </div>
        <div>
          <h6>Total de projets AGIR non-sauvegardés:</h6>
          <p>
            <a class="text-primary" [routerLink]="" queryParamsHandling="preserve" (click)="reportSaveFailures()">
              {{ saveResult?.totalFail || 0 }}
            </a>
          </p>
        </div>
        <div>
          <h6>Pourcentage de succès:</h6>
          <p>{{ saveResult?.successPercentage || 0 }}%</p>
        </div>
      </div>
    </div>
  </div>
  <div class="form-group mb-3">
    <h5 for="file">Fichier Excel</h5>
    <app-file accept=".xls,.xlsx" formControlName="excel" placeholder="Sélectionnez un fichier Excel..."></app-file>
  </div>
  <app-form-errors formControlName="excel">
    <app-form-error *appFormError="let e; key: 'required'">Le fichier est requis</app-form-error>
    <app-form-error *appFormError="let e; key: 'fileType'">
      Le fichier doit être de type Excel (.xls, .xlsx)
    </app-form-error>
  </app-form-errors>
  <div class="mb-2">
    <h5>Fichiers intersections</h5>
    <div class="d-flex">
      <div class="form-group flex-fill pr-4">
        <label for="file">Fichier intersections.dbf</label>
        <app-file
          accept=".dbf"
          formControlName="intersectionsdbf"
          placeholder="Sélectionnez le fichier intersections.dbf..."
        ></app-file>
        <app-form-errors formControlName="intersectionsdbf">
          <app-form-error *appFormError="let e; key: 'required'">Le fichier est requis</app-form-error>
          <app-form-error *appFormError="let e; key: 'fileType'">
            Le fichier doit être de type DatabaseFile (.dbf)
          </app-form-error>
        </app-form-errors>
      </div>
      <div class="form-group flex-fill pl-4">
        <label for="file">Fichier intersections.shp</label>
        <app-file
          accept=".shp"
          formControlName="intersectionsshp"
          placeholder="Sélectionnez le fichier intersections.shp..."
        ></app-file>
        <app-form-errors formControlName="intersectionsshp">
          <app-form-error *appFormError="let e; key: 'required'">Le fichier est requis</app-form-error>
          <app-form-error *appFormError="let e; key: 'fileType'">
            Le fichier doit être de type ShapeFile (.shp)
          </app-form-error>
        </app-form-errors>
      </div>
    </div>
  </div>
  <div>
    <h5>Fichiers intervalles</h5>
    <div class="d-flex">
      <div class="form-group flex-fill pr-4">
        <label for="file">Fichier intervalles.dbf</label>
        <app-file
          accept=".dbf"
          formControlName="intervallesdbf"
          placeholder="Sélectionnez le fichier intervalles.dbf..."
        ></app-file>
        <app-form-errors formControlName="intervallesdbf">
          <app-form-error *appFormError="let e; key: 'required'">Le fichier est requis</app-form-error>
          <app-form-error *appFormError="let e; key: 'fileType'">
            Le fichier doit être de type DatabaseFile (.dbf)
          </app-form-error>
        </app-form-errors>
      </div>
      <div class="form-group flex-fill pl-4">
        <label for="file">Fichier intervalles.shp</label>
        <app-file
          accept=".shp"
          formControlName="intervallesshp"
          placeholder="Sélectionnez le fichier intervalles.shp..."
        ></app-file>
        <app-form-errors formControlName="intervallesshp">
          <app-form-error *appFormError="let e; key: 'required'">Le fichier est requis</app-form-error>
          <app-form-error *appFormError="let e; key: 'fileType'">
            Le fichier doit être de type ShapeFile (.shp)
          </app-form-error>
        </app-form-errors>
      </div>
    </div>
  </div>
  <div>
    <h5>Fichiers logos</h5>
    <div class="d-flex">
      <div class="form-group flex-fill pr-4">
        <label for="file">Fichier logos.dbf</label>
        <app-file
          accept=".dbf"
          formControlName="logosdbf"
          placeholder="Sélectionnez le fichier logos.dbf..."
        ></app-file>
        <app-form-errors formControlName="logosdbf">
          <app-form-error *appFormError="let e; key: 'required'">Le fichier est requis</app-form-error>
          <app-form-error *appFormError="let e; key: 'fileType'">
            Le fichier doit être de type DatabaseFile (.dbf)
          </app-form-error>
        </app-form-errors>
      </div>
      <div class="form-group flex-fill pl-4">
        <label for="file">Fichier logos.shp</label>
        <app-file
          accept=".shp"
          formControlName="logosshp"
          placeholder="Sélectionnez le fichier logos.shp..."
        ></app-file>
        <app-form-errors formControlName="logosshp">
          <app-form-error *appFormError="let e; key: 'required'">Le fichier est requis</app-form-error>
          <app-form-error *appFormError="let e; key: 'fileType'">
            Le fichier doit être de type ShapeFile (.shp)
          </app-form-error>
        </app-form-errors>
      </div>
    </div>
  </div>
  <div class="flex-fill d-flex justify-content-end pb-5">
    <button class="btn btn-squared btn-primary" [disabled]="!form.valid || form.disabled" type="submit">
      Lancer l'import
    </button>
  </div>
</form>
