<app-layout-modal [modalTitle]="title" [showFooter]="false">
  <div body class="mx-3">
    <h3 class="mt-3 mb-3">Importation de données</h3>
    <form [formGroup]="form">
      <div class="row">
        <div class="col-md-3">
          <div class="m-1">
            <h5 class="pb-1">Interventions du Service de l'eau</h5>
            <div *ngIf="canEditFileAndLaunchImport">
              <app-toolbox-file
                formControlName="waterServiceFile"
                defaultValue="ou déposer votre fichier ici"
                buttonSizeClass="btn"
                selectorButtonClass="py-1"
                isLabelStatic="true"
                [invalidBorderStyle]="
                  form.controls.waterServiceFile.touched && form.controls.waterServiceFile.invalid
                    ? 'border-invalid'
                    : ''
                "
                [uniqueId]="0"
              >
              </app-toolbox-file>
              <app-form-errors formControlName="waterServiceFile">
                <app-form-error *appFormError="let e; key: 'fileType'">
                  Ce type de fichier n'est pas supporté
                </app-form-error>
              </app-form-errors>
            </div>
            <div
              *ngIf="form.controls.waterServiceFile.value && form.controls.waterServiceFile.valid"
              class="d-flex flex-1 justify-content-between align-items-center px-0 py-3"
            >
              <div class="d-flex">
                <i class="icon icon-file align-self-center pr-2"></i>
                <div class="d-flex flex-column">
                  <span class="font-weight-bold text-dark">{{ form.controls.waterServiceFile.value.name }}</span>
                  <small class="file-size"
                    >{{ (form.controls.waterServiceFile.value.size / DIVISOR_MO).toFixed(2) }} Mo</small
                  >
                </div>
              </div>
              <button
                *ngIf="canEditFileAndLaunchImport"
                class="btn btn-icon-only p-0"
                (click)="removeFile(form.controls.waterServiceFile)"
              >
                <i class="icon icon-trash icon-color-platinum m-0"></i>
              </button>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="m-1">
            <h5 class="pb-1">Interventions - Données budgétaires</h5>
            <div *ngIf="canEditFileAndLaunchImport">
              <app-toolbox-file
                formControlName="budgetFile"
                defaultValue="ou déposer votre fichier ici"
                buttonSizeClass="btn"
                selectorButtonClass="py-1"
                isLabelStatic="true"
                [invalidBorderStyle]="
                  form.controls.budgetFile.touched && form.controls.budgetFile.invalid ? 'border-invalid' : ''
                "
                [uniqueId]="1"
              >
              </app-toolbox-file>
              <app-form-errors formControlName="budgetFile">
                <app-form-error *appFormError="let e; key: 'fileType'">
                  Ce type de fichier n'est pas supporté
                </app-form-error>
              </app-form-errors>
            </div>
            <div
              *ngIf="form.controls.budgetFile.value && form.controls.budgetFile.valid"
              class="d-flex flex-1 justify-content-between align-items-center px-0 py-3"
            >
              <div class="d-flex">
                <i class="icon icon-file align-self-center pr-2"></i>
                <div class="d-flex flex-column">
                  <span class="font-weight-bold text-dark">{{ form.controls.budgetFile.value.name }}</span>
                  <small class="file-size"
                    >{{ (form.controls.budgetFile.value.size / DIVISOR_MO).toFixed(2) }} Mo</small
                  >
                </div>
              </div>
              <button
                *ngIf="canEditFileAndLaunchImport"
                class="btn btn-icon-only p-0"
                (click)="removeFile(form.controls.budgetFile)"
              >
                <i class="icon icon-trash icon-color-platinum m-0"></i>
              </button>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="m-1">
            <h5 class="pb-1">Réhabilitation des aqueducs - Données conception</h5>
            <div *ngIf="canEditFileAndLaunchImport">
              <app-toolbox-file
                formControlName="rehabAqueductFile"
                defaultValue="ou déposer votre fichier ici"
                buttonSizeClass="btn"
                selectorButtonClass="py-1"
                isLabelStatic="true"
                [invalidBorderStyle]="
                  form.controls.rehabAqueductFile.touched && form.controls.rehabAqueductFile.invalid
                    ? 'border-invalid'
                    : ''
                "
                [uniqueId]="3"
              >
              </app-toolbox-file>
              <app-form-errors formControlName="rehabAqueductFile">
                <app-form-error *appFormError="let e; key: 'fileType'">
                  Ce type de fichier n'est pas supporté
                </app-form-error>
              </app-form-errors>
            </div>
            <div
              *ngIf="form.controls.rehabAqueductFile.value && form.controls.rehabAqueductFile.valid"
              class="d-flex flex-1 justify-content-between align-items-center px-0 py-3"
            >
              <div class="d-flex">
                <i class="icon icon-file align-self-center pr-2"></i>
                <div class="d-flex flex-column">
                  <span class="font-weight-bold text-dark">{{ form.controls.rehabAqueductFile.value.name }}</span>
                  <small class="file-size"
                    >{{ (form.controls.rehabAqueductFile.value.size / DIVISOR_MO).toFixed(2) }} Mo</small
                  >
                </div>
              </div>
              <button
                *ngIf="canEditFileAndLaunchImport"
                class="btn btn-icon-only p-0"
                (click)="removeFile(form.controls.rehabAqueductFile)"
              >
                <i class="icon icon-trash icon-color-platinum m-0"></i>
              </button>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="m-1">
            <h5 class="pb-1">Réhabilitation des égouts - Données conception</h5>
            <div *ngIf="canEditFileAndLaunchImport">
              <app-toolbox-file
                formControlName="rehabEgoutFile"
                defaultValue="ou déposer votre fichier ici"
                buttonSizeClass="btn"
                selectorButtonClass="py-1"
                isLabelStatic="true"
                [invalidBorderStyle]="
                  form.controls.rehabEgoutFile.touched && form.controls.rehabEgoutFile.invalid ? 'border-invalid' : ''
                "
                [uniqueId]="2"
              >
              </app-toolbox-file>
              <app-form-errors formControlName="rehabEgoutFile">
                <app-form-error *appFormError="let e; key: 'fileType'">
                  Ce type de fichier n'est pas supporté
                </app-form-error>
              </app-form-errors>
            </div>
            <div
              *ngIf="form.controls.rehabEgoutFile.value && form.controls.rehabEgoutFile.valid"
              class="d-flex flex-1 justify-content-between align-items-center px-0 py-3"
            >
              <div class="d-flex">
                <i class="icon icon-file align-self-center pr-2"></i>
                <div class="d-flex flex-column">
                  <span class="font-weight-bold text-dark">{{ form.controls.rehabEgoutFile.value.name }}</span>
                  <small class="file-size"
                    >{{ (form.controls.rehabEgoutFile.value.size / DIVISOR_MO).toFixed(2) }} Mo</small
                  >
                </div>
              </div>
              <button
                *ngIf="canEditFileAndLaunchImport"
                class="btn btn-icon-only p-0"
                (click)="removeFile(form.controls.rehabEgoutFile)"
              >
                <i class="icon icon-trash icon-color-platinum m-0"></i>
              </button>
            </div>
          </div>
        </div>
        <div class="w-100" *ngIf="isImportInProgress || isImportSuccess">
          <ngb-progressbar
            [striped]="isImportInProgress"
            [animated]="isImportInProgress"
            [value]="loadingPercentage"
          ></ngb-progressbar>
          <div class="d-flex justify-content-between pt-1">
            <p>{{ currentStep.label }}</p>
            <p class="font-weight-bold">{{ loadingPercentage }} %</p>
          </div>
        </div>
      </div>
    </form>
    <div *ngIf="isImportFailed" class="mt-3">
      <h5 class="text-danger">L'importation a échoué, l'un des fichiers est invalide.</h5>
      <h5 class="text-danger white-space-pre-line">{{ lastNexoImportLog.files[0].errorDescription }}</h5>
    </div>
    <button
      *ngIf="canEditFileAndLaunchImport"
      class="btn btn-primary btn-squared mt-3"
      type="button"
      [disabled]="!form.controls.waterServiceFile.valid || form.disabled"
      (click)="launchImport()"
    >
      Lancer l'importation
    </button>
    <div *ngIf="isImportInProgress || isImportFailed || isImportSuccess">
      <hr class="divisor" />
      <div class="d-flex mb-3">
        <h3 class="pr-1">Résultat de l'importation</h3>
        <span *ngIf="isImportFailed" class="align-self-center badge badge-danger">Échec</span>
        <span *ngIf="isImportSuccess" class="align-self-center badge badge-success">Succès</span>
      </div>
      <table class="table-md-responsive mb-4">
        <tbody class="table-label-value">
          <tr>
            <td class="row-title">Responsable</td>
            <td>{{ firstNexoImportLog.audit.createdBy.displayName }}</td>
          </tr>
        </tbody>
      </table>

      <div class="row">
        <div class="col-md-3">
          <h5 class="mb-2">Interventions du Service de l'eau</h5>
          <table class="table-md-responsive mb-4">
            <tbody class="table-results table-label-value">
              <tr>
                <td class="text-secondary">Nombre d'interventions à importer</td>
                <td>{{ importResults.interventionsToImport | vdmNa }}</td>
              </tr>
              <tr>
                <td class="text-secondary">Nombre d'interventions créées</td>
                <td>{{ importResults.createdInterventions | vdmNa }}</td>
              </tr>
              <tr>
                <td class="text-secondary">Nombre d'interventions mise à jour</td>
                <td>{{ importResults.updatedInterventions | vdmNa }}</td>
              </tr>
              <tr>
                <td class="text-secondary">Nombre d'interventions annulées</td>
                <td>{{ importResults.canceledInterventions | vdmNa }}</td>
              </tr>
              <tr>
                <td class="text-secondary">Nombre d'interventions en erreur</td>
                <td>{{ importResults.errorInterventions | vdmNa }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="col-md-3" *ngIf="importBudgetResults">
          <h5 class="mb-2">Interventions - Données budgétaires</h5>
          <table class="table-md-responsive mb-4">
            <tbody class="table-results table-label-value">
              <tr>
                <td class="text-secondary">Nombre d'interventions</td>
                <td>{{ importBudgetResults.interventionsToImport | vdmNa }}</td>
              </tr>
              <tr>
                <td class="text-secondary">Nombre d'interventions mise à jour</td>
                <td>{{ importBudgetResults.updatedInterventions | vdmNa }}</td>
              </tr>
              <tr>
                <td class="text-secondary">Nombre d'interventions en erreur</td>
                <td>{{ importBudgetResults.errorInterventions | vdmNa }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="col-md-3" *ngIf="importRehabAqueductResults">
          <h5 class="mb-2">Réhablitation des aqueducs - Données conception</h5>
          <table class="table-md-responsive mb-4">
            <tbody class="table-results table-label-value">
              <tr>
                <td class="text-secondary">Nombre d'interventions</td>
                <td>{{ importRehabAqueductResults.interventionsToImport | vdmNa }}</td>
              </tr>
              <tr>
                <td class="text-secondary">Nombre d'interventions mise à jour</td>
                <td>{{ importRehabAqueductResults.updatedInterventions | vdmNa }}</td>
              </tr>
              <tr>
                <td class="text-secondary">Nombre d'interventions en erreur</td>
                <td>{{ importRehabAqueductResults.errorInterventions | vdmNa }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="col-md-3" *ngIf="importRehabEgoutResults">
          <h5 class="mb-2">Réhabilitation des égouts - Données conception</h5>
          <table class="table-md-responsive mb-4">
            <tbody class="table-results table-label-value">
              <tr>
                <td class="text-secondary">Nombre d'interventions</td>
                <td>{{ importRehabEgoutResults.interventionsToImport | vdmNa }}</td>
              </tr>
              <tr>
                <td class="text-secondary">Nombre d'interventions mise à jour</td>
                <td>{{ importRehabEgoutResults.updatedInterventions | vdmNa }}</td>
              </tr>
              <tr>
                <td class="text-secondary">Nombre d'interventions en erreur</td>
                <td>{{ importRehabEgoutResults.errorInterventions | vdmNa }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <button class="btn btn-primary btn-squared mt-3" type="button" (click)="finishImport()">
        Terminer
      </button>
    </div>
  </div>
</app-layout-modal>
