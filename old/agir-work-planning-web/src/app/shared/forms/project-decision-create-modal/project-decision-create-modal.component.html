<app-layout-modal modalTitle="Ajouter une décision">
  <div body>
    <form [formGroup]="form">
      <div class="d-flex pb-2">
        <div class="d-flex flex-column flex-grow-1 pr-2">
          <div>
            <label class="font-weight-bold">Décision</label>
          </div>
          <div>
            <vdm-select
              class="flex-fill"
              bindLabel="label.fr"
              bindValue="code"
              formControlName="decisionType"
              [closeOnSelect]="false"
              [items]="decisionTypes$ | async"
            ></vdm-select>
            <app-form-errors formControlName="decisionType">
              <app-form-error *appFormError="let e; key: 'required'">Une décision doit être prise</app-form-error>
            </app-form-errors>
          </div>
        </div>

        <div class="d-flex flex-column flex-grow-1 pr-2">
          <div>
            <label class="font-weight-bold">Année début</label>
          </div>
          <div>
            <vdm-select
              class="flex-fill"
              bindLabel="label.fr"
              formControlName="startYear"
              appendTo="app-project-decision-create-modal"
              [closeOnSelect]="false"
              [items]="years"
            ></vdm-select>
            <app-form-errors formControlName="startYear">
              <app-form-error *appFormError="let e; key: 'required'">L'année de début est requise</app-form-error>
            </app-form-errors>
          </div>
        </div>

        <div class="d-flex flex-column flex-grow-1 pr-2">
          <div>
            <label class="font-weight-bold">Année de fin</label>
          </div>
          <div>
            <vdm-select
              class="flex-fill"
              bindLabel="label.fr"
              formControlName="endYear"
              appendTo="app-project-decision-create-modal"
              [closeOnSelect]="false"
              [items]="years"
            ></vdm-select>
            <app-form-errors formControlName="endYear">
              <app-form-error *appFormError="let e; key: 'required'">L'année de fin est requise</app-form-error>
            </app-form-errors>
          </div>
        </div>
      </div>
      <div class="d-flex flex-column">
        <div>
          <label class="font-weight-bold">Justificatifs</label>
        </div>
        <div>
          <textarea formControlName="justification" class="form-control w-100"></textarea>
        </div>
        <app-form-errors formControlName="justification">
          <app-form-error *appFormError="let e; key: 'required'">Le justificatif est requis</app-form-error>
        </app-form-errors>
      </div>
    </form>
    <app-alert *ngIf="validated && form.get('decisionType').value !== 'canceled'" class="mt-2" type="warning">
      <span title>Attention!</span>
      <span *ngIf="!projectHasProgramBooks" description>
        Cette décision s'appliquera à l'ensemble du projet ainsi qu'à toutes ses interventions. Êtes-vous certain
        d'appliquer cette décision?
      </span>
      <span *ngIf="projectHasProgramBooks" description>
        Cette décision s'appliquera à l'ensemble du projet ainsi qu'à toutes ses interventions.
        <br />
        <br />
        Cette décision va également retirer le projet sélectionné
        <ng-container *ngIf="projectAnnualPrograms.length > 1">
          des programmations annuelles
          <br />
          <ng-container *ngFor="let annualProgram of projectAnnualPrograms">
            {{ annualProgram.year }} {{ annualProgram.executorId | appTaxonomy: 'executor' }}
            <br />
          </ng-container>
        </ng-container>
        <ng-container *ngIf="projectAnnualPrograms.length === 1">
          de la programmation annuelle
          {{ projectAnnualPrograms[0].year }} {{ projectAnnualPrograms[0].executorId | appTaxonomy: 'executor' }}.
        </ng-container>
        Êtes-vous certains d'appliquer cette décision?
      </span>
    </app-alert>
    <app-alert *ngIf="form.get('decisionType').value === 'canceled'" class="mt-2" type="danger">
      <span title>Attention!</span>
      <span description>Vous allez annuler le projet, cette action est irréversible</span>
    </app-alert>
  </div>
  <div buttons>
    <button type="button" class="btn btn-tertiary btn-squared bg-white mr-2" (click)="cancel()">
      Annuler
    </button>
    <button type="button" class="btn btn-primary btn-squared" (click)="submit()">
      Ajouter
    </button>
  </div>
</app-layout-modal>
